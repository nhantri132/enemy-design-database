<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enemy Design Database</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        header h1 {
            text-align: center;
            font-size: 2em;
        }

        .auth-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .user-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .sign-in-prompt {
            background: white;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sign-in-prompt h2 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .sign-in-prompt p {
            margin-bottom: 20px;
            color: #7f8c8d;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 10px;
        }

        .search-box {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-section.hidden {
            display: none;
        }

        .form-section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group select option:first-child {
            color: #999;
        }

        .form-group select:invalid {
            color: #999;
        }

        .form-group select:valid {
            color: #333;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Complex sections */
        .complex-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .complex-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .list-item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .field-inline {
            display: flex;
            flex-direction: column;
        }

        .field-inline label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 3px;
        }

        .field-inline input,
        .field-inline select {
            padding: 6px;
            font-size: 13px;
        }

        .trait-item {
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .empty-list {
            color: #95a5a6;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .enemy-list {
            background: transparent;
        }

        .enemy-card {
            padding: 25px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .enemy-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .enemy-card:nth-child(even) {
            background: #f8f9fa;
        }

        .enemy-card:last-child {
            margin-bottom: 0;
        }

        .enemy-compact-info {
            /* This stays visible always */
        }

        .enemy-detailed-info {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .enemy-detailed-info.expanded {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        .expand-button {
            margin-top: 15px;
            padding: 8px 16px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            width: fit-content;
        }

        .expand-button:hover {
            background: #bdc3c7;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .enemy-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .enemy-title {
            flex: 1;
        }

        .enemy-title h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .enemy-game {
            color: #7f8c8d;
            font-size: 14px;
        }

        .enemy-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #ecf0f1;
            color: #555;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.type { background: #3498db; color: white; }
        .badge.size { background: #9b59b6; color: white; }
        .badge.weapon { background: #e67e22; color: white; }

        .enemy-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .enemy-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .action-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .action-display strong {
            color: #2c3e50;
        }

        .enemy-notes {
            margin-top: 10px;
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }

        .enemy-links {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .enemy-links a {
            color: #3498db;
            text-decoration: none;
            font-size: 14px;
        }

        .enemy-links a:hover {
            text-decoration: underline;
        }

        .enemy-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .enemy-actions button {
            padding: 6px 12px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .stats {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stats h3 {
            color: #2c3e50;
            font-size: 2em;
        }

        .stats p {
            color: #7f8c8d;
        }

        .migration-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .migration-banner.hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .variant-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #e8f4f8;
            padding: 5px 10px;
            border-radius: 5px;
            color: #2c3e50;
            text-decoration: none;
            font-size: 13px;
        }

        .variant-link:hover {
            background: #d4ebf2;
        }

        .about-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .about-link:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-content a {
            color: #3498db;
            text-decoration: none;
        }

        .modal-content a:hover {
            text-decoration: underline;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #000;
        }
        
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>🎮 Enemy Design Database</h1>
            <a class="about-link" onclick="openAbout()">ℹ️ About</a>
        </div>
    </header>

    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAbout()">&times;</span>
            <h2>About Enemy Design Database</h2>
            <p style="margin-top: 15px; line-height: 1.8;">
                This database is a reference tool for cataloging and analyzing enemy designs across video games. This is NOT comprehensive as their are many enemy details and systems hidden to the player.
            </p>
            <h3 style="margin-top: 20px; color: #2c3e50;">Purpose</h3>
            <p style="margin-top: 10px; line-height: 1.8;">
                Document enemy combat behaviors, movement patterns, and design philosophies to build a searchable library of combat design patterns for combat designers to reference.
            </p>
            <h3 style="margin-top: 20px; color: #2c3e50;">How to Use</h3>
            <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                <li><strong>Anyone can view</strong> all enemy entries</li>
                <li>Currently, <strong>only Tri</strong> can add, edit, or delete entries</li>
                <li><strong>Search</strong> across all fields (name, game, damage types, actions, etc.)</li>
                <li><strong>Click "Show Details"</strong> to expand enemy information</li>
            </ul>
            <h3 style="margin-top: 20px; color: #2c3e50;">Contact</h3>
            <p style="margin-top: 10px; line-height: 1.8;">
                Created by Tri Nguyen. Check me out here: <a href="https://linktr.ee/trigrows" target="_blank">linktr.ee/trigrows</a>
            </p>
        </div>
    </div>

    <div class="container">
        <div id="authSection"></div>

        <div id="migrationBanner" class="migration-banner hidden">
            <div>
                <strong>Local data found!</strong> You have enemies saved locally. Migrate them to the cloud?
            </div>
            <button class="btn btn-success" onclick="migrateLocalData()">Migrate Now</button>
        </div>

        <div class="stats">
            <h3 id="enemyCount">-</h3>
            <p>Enemies Cataloged</p>
        </div>

        <div id="mainContent" class="loading">
            <p>Loading...</p>
        </div>

        <div class="controls hidden" id="controls">
            <input type="text" id="searchBox" class="search-box" placeholder="Search by enemy name or game...">
            <button class="btn" id="addNewBtn" disabled>+ Add New Enemy</button>
        </div>

        <div class="form-section hidden" id="formSection">
            <h2 id="formTitle">Add New Enemy</h2>
            <form id="enemyForm">
                <!-- Basic Info -->
                <div class="form-group">
                    <label for="enemyName">Enemy Name *</label>
                    <input type="text" id="enemyName" placeholder="What's the enemy's name?" autocomplete="off" required>
                </div>

                <div class="form-group">
                    <label for="gameName">Game *</label>
                    <input type="text" id="gameName" list="gameOptions" placeholder="What game are they from?" autocomplete="off" required>
                    <datalist id="gameOptions"></datalist>
                </div>

                <div class="form-group">
                    <label for="enemyType">Enemy Type</label>
                    <select id="enemyType">
                        <option value="">How tough are they?</option>
                        <option value="Regular">Regular</option>
                        <option value="Elite">Elite</option>
                        <option value="Mini-Boss">Mini-Boss</option>
                        <option value="Boss">Boss</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="enemySize">Enemy Size</label>
                    <select id="enemySize">
                        <option value="">How big are they? Medium is the size of the player.</option>
                        <option value="Tiny">Tiny</option>
                        <option value="Small">Small</option>
                        <option value="Medium">Medium</option>
                        <option value="Large">Large</option>
                        <option value="Huge">Huge</option>
                        <option value="Gargantuan">Gargantuan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="enemyFaction">Enemy Faction</label>
                    <input type="text" id="enemyFaction" list="factionOptions" placeholder="e.g., Undead Legion, Crimson Fleet, etc." autocomplete="off">
                    <datalist id="factionOptions"></datalist>
                </div>

                <div class="form-group">
                    <label for="enemyWeapon">Weapon Type</label>
                    <input type="text" id="enemyWeapon" list="weaponOptions" placeholder="Select or type custom weapon..." autocomplete="off">
                    <datalist id="weaponOptions"></datalist>
                </div>

                <div class="form-group">
                    <label for="referenceLink">Reference Link</label>
                    <input type="url" id="referenceLink" placeholder="https://wiki.example.com/enemy" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="videoLink">Video Reference</label>
                    <input type="url" id="videoLink" placeholder="https://youtube.com/..." autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="imageLink">Image Reference</label>
                    <input type="url" id="imageLink" placeholder="https://example.com/image.jpg" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="notes">Notes & Analysis</label>
                    <textarea id="notes" placeholder="Your observations about this enemy's design..."></textarea>
                </div>

                <!-- Offensive Actions -->
                <div class="complex-section">
                    <h3>
                        Offensive Actions
                        <button type="button" class="btn btn-small btn-success" onclick="addOffensiveAction()">+ Add Action</button>
                    </h3>
                    <div id="offensiveActionsList"></div>
                </div>

                <!-- Defensive Actions -->
                <div class="complex-section">
                    <h3>
                        Defensive Actions
                        <button type="button" class="btn btn-small btn-success" onclick="addDefensiveAction()">+ Add Action</button>
                    </h3>
                    <div id="defensiveActionsList"></div>
                </div>

                <!-- Support Actions -->
                <div class="complex-section">
                    <h3>
                        Support Actions
                        <button type="button" class="btn btn-small btn-success" onclick="addSupportAction()">+ Add Action</button>
                    </h3>
                    <div id="supportActionsList"></div>
                </div>

                <!-- Reactions -->
                <div class="complex-section">
                    <h3>
                        Reactions
                        <button type="button" class="btn btn-small btn-success" onclick="addReaction()">+ Add Reaction</button>
                    </h3>
                    <div id="reactionsList"></div>
                </div>

                <!-- Locomotion -->
                <div class="complex-section">
                    <h3>
                        Locomotion
                        <button type="button" class="btn btn-small btn-success" onclick="addLocomotion()">+ Add Locomotion</button>
                    </h3>
                    <div id="locomotionList"></div>
                </div>

                <!-- Special Traits -->
                <div class="complex-section">
                    <h3>
                        Special Traits
                        <button type="button" class="btn btn-small btn-success" onclick="addSpecialTrait()">+ Add Trait</button>
                    </h3>
                    <div id="specialTraitsList"></div>
                </div>

                <!-- Variant -->
                <div class="form-group">
                    <label for="variantEnemy">Variant (Link to similar enemy)</label>
                    <input type="text" id="variantEnemy" list="variantOptions" placeholder="Type to search for an enemy...">
                    <datalist id="variantOptions"></datalist>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn" id="saveBtn">Save Enemy</button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                </div>
            </form>
        </div>

        <div class="enemy-list" id="enemyList"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyBO6IwnOdqFbC7Hf65sifksRDaKnjZmM",
            authDomain: "enemy-design-database.firebaseapp.com",
            databaseURL: "https://enemy-design-database-default-rtdb.firebaseio.com",
            projectId: "enemy-design-database",
            storageBucket: "enemy-design-database.firebasestorage.app",
            messagingSenderId: "652811505513",
            appId: "1:652811505513:web:cbe13d7665b4fa991177f8"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let enemies = {};
        let editingKey = null;

        // Temporary storage for complex lists
        let offensiveActions = [];
        let defensiveActions = [];
        let supportActions = [];
        let reactions = [];
        let locomotion = [];
        let specialTraits = [];

        auth.onAuthStateChanged((user) => {
            currentUser = user;
            renderAuthSection();
            loadEnemies();  // Load enemies regardless of auth state
            
            if (user) {
                checkForLocalData();
            }
        });

        function renderAuthSection() {
            const authSection = document.getElementById('authSection');
            
            if (currentUser) {
                authSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-details">
                            <img src="${currentUser.photoURL}" alt="${currentUser.displayName}" class="user-avatar">
                            <div>
                                <strong>${currentUser.displayName}</strong>
                                <div style="font-size: 12px; color: #7f8c8d;">${currentUser.email}</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
                    </div>
                `;
                document.getElementById('addNewBtn').disabled = false;
            } else {
                authSection.innerHTML = `
                    <div class="sign-in-prompt">
                        <h2>Welcome to Enemy Design Database!</h2>
                        <p>Currently, only Tri can add enemies but anyone can view the database.</p>
                        <p>You can check me out here: linktr.ee/trigrows</p>
                        <button class="btn" onclick="signIn()">Sign in with Google</button>
                    </div>
                `;
                document.getElementById('addNewBtn').disabled = true;
            }
        }

        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                alert('Sign in failed: ' + error.message);
            });
        }

        function signOut() {
            auth.signOut();
        }

        function checkForLocalData() {
            const localData = localStorage.getItem('enemyDatabase');
            if (localData) {
                const localEnemies = JSON.parse(localData);
                if (localEnemies.length > 0) {
                    document.getElementById('migrationBanner').classList.remove('hidden');
                }
            }
        }

        function migrateLocalData() {
            const localData = localStorage.getItem('enemyDatabase');
            if (!localData) return;
            
            const localEnemies = JSON.parse(localData);
            const enemiesRef = database.ref('enemies');
            
            let migrated = 0;
            localEnemies.forEach((enemy) => {
                enemiesRef.push(enemy);
                migrated++;
            });
            
            localStorage.removeItem('enemyDatabase');
            document.getElementById('migrationBanner').classList.add('hidden');
            alert(`Successfully migrated ${migrated} enemies to the cloud!`);
        }

        function openAbout() {
            document.getElementById('aboutModal').classList.add('active');
        }

        function closeAbout() {
            document.getElementById('aboutModal').classList.remove('active');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('aboutModal');
            if (event.target === modal) {
                closeAbout();
            }
        }

        function loadEnemies() {
            const enemiesRef = database.ref('enemies');
            
            enemiesRef.on('value', (snapshot) => {
                enemies = snapshot.val() || {};
                renderEnemies();
                updateCount();
                updateVariantDropdown();
                updateFormDatalists();
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('controls').classList.remove('hidden');
            });
        }

        function updateCount() {
            const count = Object.keys(enemies).length;
            document.getElementById('enemyCount').textContent = count;
        }

        function toggleEnemyDetails(key) {
            const details = document.getElementById(`details-${key}`);
            const icon = document.getElementById(`icon-${key}`);
            const text = document.getElementById(`text-${key}`);
            
            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                icon.classList.remove('expanded');
                text.textContent = 'Show Details';
            } else {
                details.classList.add('expanded');
                icon.classList.add('expanded');
                text.textContent = 'Hide Details';
            }
        }

        function updateFormDatalists() {
            // Get unique values from database
            const games = new Set();
            const factions = new Set();
            const weapons = new Set();
            
            Object.values(enemies).forEach(enemy => {
                if (enemy.game) games.add(enemy.game);
                if (enemy.faction) factions.add(enemy.faction);
                if (enemy.weapon) weapons.add(enemy.weapon);
            });
            
            // Update Game datalist
            const gameList = document.getElementById('gameOptions');
            gameList.innerHTML = '';
            Array.from(games).sort().forEach(game => {
                const option = document.createElement('option');
                option.value = game;
                gameList.appendChild(option);
            });
            
            // Update Faction datalist
            const factionList = document.getElementById('factionOptions');
            factionList.innerHTML = '';
            Array.from(factions).sort().forEach(faction => {
                const option = document.createElement('option');
                option.value = faction;
                factionList.appendChild(option);
            });
            
            // Update Weapon datalist
            const weaponList = document.getElementById('weaponOptions');
            weaponList.innerHTML = '';
            Array.from(weapons).sort().forEach(weapon => {
                const option = document.createElement('option');
                option.value = weapon;
                weaponList.appendChild(option);
            });
        }
        
        function updateVariantDropdown() {
            const datalist = document.getElementById('variantOptions');
            const input = document.getElementById('variantEnemy');
            
            // If we have a key stored, convert it to display name
            let currentDisplay = '';
            if (input.dataset.variantKey && enemies[input.dataset.variantKey]) {
                const enemy = enemies[input.dataset.variantKey];
                currentDisplay = `${enemy.name} (${enemy.game})`;
            } else {
                currentDisplay = input.value;
            }
            
            datalist.innerHTML = '';
            
            Object.keys(enemies).forEach(key => {
                if (key !== editingKey) {
                    const enemy = enemies[key];
                    const option = document.createElement('option');
                    option.value = `${enemy.name} (${enemy.game})`;
                    option.dataset.key = key;
                    datalist.appendChild(option);
                }
            });
            
            input.value = currentDisplay;
        }

        function findAllVariants(enemyKey) {
            const variantNetwork = new Set();
            const visited = new Set();
            
            function explore(key) {
                if (visited.has(key) || !enemies[key]) return;
                visited.add(key);
                
                // Check if this enemy links to others
                if (enemies[key].variant && enemies[key].variant !== '') {
                    variantNetwork.add(enemies[key].variant);
                    explore(enemies[key].variant);
                }
                
                // Find enemies that link to this one (reverse lookup)
                Object.keys(enemies).forEach(otherKey => {
                    if (enemies[otherKey].variant === key) {
                        variantNetwork.add(otherKey);
                        explore(otherKey);
                    }
                });
            }
            
            explore(enemyKey);
            variantNetwork.delete(enemyKey); // Remove self
            
            return Array.from(variantNetwork);
        }
        
        // Offensive Actions
        function addOffensiveAction() {
            const action = {
                id: Date.now(),
                name: '',
                type: '',
                range: '',
                comboCount: '',
                windupTime: '',
                damageType: '',
                condition: '',
                details: ''
            };
            offensiveActions.push(action);
            renderOffensiveActions();
        }

        function removeOffensiveAction(id) {
            offensiveActions = offensiveActions.filter(a => a.id !== id);
            renderOffensiveActions();
        }

        function renderOffensiveActions() {
            const container = document.getElementById('offensiveActionsList');
            
            if (offensiveActions.length === 0) {
                container.innerHTML = '<div class="empty-list">Offensive actions are enemy actions primarily designed to damage their target</div>';
                return;
            }
            
            container.innerHTML = offensiveActions.map(action => `
                <div class="list-item">
                    <div class="list-item-header">
                        <strong>Action ${offensiveActions.indexOf(action) + 1}</strong>
                        <button type="button" class="btn btn-small btn-danger" onclick="removeOffensiveAction(${action.id})">Remove</button>
                    </div>
                    <div class="field-inline" style="margin-bottom: 10px;">
                        <label>Action Name</label>
                        <input type="text" value="${action.name}" onchange="updateOffensiveAction(${action.id}, 'name', this.value)" placeholder="e.g., Slash, Fireball, Charge">
                    </div>
                    <div class="list-item-grid">
                        <div class="field-inline">
                            <label>Type</label>
                            <select onchange="updateOffensiveAction(${action.id}, 'type', this.value)" value="${action.type}">
                                <option value="">Select...</option>
                                <option value="melee" ${action.type === 'melee' ? 'selected' : ''}>Melee</option>
                                <option value="ranged" ${action.type === 'ranged' ? 'selected' : ''}>Ranged</option>
                                <option value="grab" ${action.type === 'grab' ? 'selected' : ''}>Grab</option>
                                <option value="aoe" ${action.type === 'aoe' ? 'selected' : ''}>AOE</option>
                            </select>
                        </div>
                        <div class="field-inline">
                            <label>Range</label>
                            <select onchange="updateOffensiveAction(${action.id}, 'range', this.value)">
                                <option value="">Select...</option>
                                <option value="close" ${action.range === 'close' ? 'selected' : ''}>Close</option>
                                <option value="medium" ${action.range === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="far" ${action.range === 'far' ? 'selected' : ''}>Far</option>
                            </select>
                        </div>
                        <div class="field-inline">
                            <label>Combo Count</label>
                            <input type="number" value="${action.comboCount}" onchange="updateOffensiveAction(${action.id}, 'comboCount', this.value)" min="0">
                        </div>
                        <div class="field-inline">
                            <label>Windup Time</label>
                            <select onchange="updateOffensiveAction(${action.id}, 'windupTime', this.value)">
                                <option value="">Select...</option>
                                <option value="slow" ${action.windupTime === 'slow' ? 'selected' : ''}>Slow</option>
                                <option value="medium" ${action.windupTime === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="fast" ${action.windupTime === 'fast' ? 'selected' : ''}>Fast</option>
                            </select>
                        </div>
                        <div class="field-inline">
                            <label>Damage Type</label>
                            <select onchange="updateOffensiveAction(${action.id}, 'damageType', this.value)">
                                <option value="">Select...</option>
                                <option value="physical" ${action.damageType === 'physical' ? 'selected' : ''}>Physical</option>
                                <option value="fire" ${action.damageType === 'fire' ? 'selected' : ''}>Fire</option>
                                <option value="ice" ${action.damageType === 'ice' ? 'selected' : ''}>Ice</option>
                                <option value="poison" ${action.damageType === 'poison' ? 'selected' : ''}>Poison</option>
                                <option value="force" ${action.damageType === 'force' ? 'selected' : ''}>Force</option>
                                <option value="lightning" ${action.damageType === 'lightning' ? 'selected' : ''}>Lightning</option>
                                <option value="psychic" ${action.damageType === 'psychic' ? 'selected' : ''}>Psychic</option>
                                <option value="radiant" ${action.damageType === 'radiant' ? 'selected' : ''}>Radiant</option>
                                <option value="necrotic" ${action.damageType === 'necrotic' ? 'selected' : ''}>Necrotic</option>
                            </select>
                        </div>
                        <div class="field-inline">
                            <label>Condition</label>
                            <select onchange="updateOffensiveAction(${action.id}, 'condition', this.value)">
                                <option value="">Select...</option>
                                <option value="blind" ${action.condition === 'blind' ? 'selected' : ''}>Blind</option>
                                <option value="deaf" ${action.condition === 'deaf' ? 'selected' : ''}>Deaf</option>
                                <option value="grappled" ${action.condition === 'grappled' ? 'selected' : ''}>Grappled</option>
                                <option value="paralyze" ${action.condition === 'paralyze' ? 'selected' : ''}>Paralyze</option>
                                <option value="poisoned" ${action.condition === 'poisoned' ? 'selected' : ''}>Poisoned</option>
                            </select>
                        </div>
                    </div>
                    <div class="field-inline">
                        <label>Details</label>
                        <textarea onchange="updateOffensiveAction(${action.id}, 'details', this.value)">${action.details}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function updateOffensiveAction(id, field, value) {
            const action = offensiveActions.find(a => a.id === id);
            if (action) action[field] = value;
        }

        // Defensive Actions
        function addDefensiveAction() {
            const action = {
                id: Date.now(),
                type: '',
                defensiveReaction: '',
                details: ''
            };
            defensiveActions.push(action);
            renderDefensiveActions();
        }

        function removeDefensiveAction(id) {
            defensiveActions = defensiveActions.filter(a => a.id !== id);
            renderDefensiveActions();
        }

        function renderDefensiveActions() {
            const container = document.getElementById('defensiveActionsList');
            
            if (defensiveActions.length === 0) {
                container.innerHTML = '<div class="empty-list">Defensive actions are enemy actions primarily designed to mitigate incoming damage</div>';
                return;
            }
            
            container.innerHTML = defensiveActions.map(action => `
                <div class="list-item">
                    <div class="list-item-header">
                        <strong>Action ${defensiveActions.indexOf(action) + 1}</strong>
                        <button type="button" class="btn btn-small btn-danger" onclick="removeDefensiveAction(${action.id})">Remove</button>
                    </div>
                    <div class="list-item-grid">
                        <div class="field-inline">
                            <label>Type</label>
                            <select onchange="updateDefensiveAction(${action.id}, 'type', this.value)">
                                <option value="">Select...</option>
                                <option value="block" ${action.type === 'block' ? 'selected' : ''}>Block</option>
                                <option value="evade" ${action.type === 'evade' ? 'selected' : ''}>Evade</option>
                                <option value="deflect" ${action.type === 'deflect' ? 'selected' : ''}>Deflect</option>
                                <option value="none" ${action.type === 'none' ? 'selected' : ''}>None</option>
                            </select>
                        </div>
                        <div class="field-inline">
                            <label>Defensive Reaction</label>
                            <select onchange="updateDefensiveAction(${action.id}, 'defensiveReaction', this.value)">
                                <option value="">Select...</option>
                                <option value="block followup" ${action.defensiveReaction === 'block followup' ? 'selected' : ''}>Block Followup</option>
                                <option value="evade followup" ${action.defensiveReaction === 'evade followup' ? 'selected' : ''}>Evade Followup</option>
                                <option value="deflect followup" ${action.defensiveReaction === 'deflect followup' ? 'selected' : ''}>Deflect Followup</option>
                                <option value="none" ${action.defensiveReaction === 'none' ? 'selected' : ''}>None</option>
                            </select>
                        </div>
                    </div>
                    <div class="field-inline">
                        <label>Details</label>
                        <textarea onchange="updateDefensiveAction(${action.id}, 'details', this.value)">${action.details}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function updateDefensiveAction(id, field, value) {
            const action = defensiveActions.find(a => a.id === id);
            if (action) action[field] = value;
        }

        // Support Actions
        function addSupportAction() {
            const action = {
                id: Date.now(),
                type: '',
                details: ''
            };
            supportActions.push(action);
            renderSupportActions();
        }

        function removeSupportAction(id) {
            supportActions = supportActions.filter(a => a.id !== id);
            renderSupportActions();
        }

        function renderSupportActions() {
            const container = document.getElementById('supportActionsList');
            
            if (supportActions.length === 0) {
                container.innerHTML = '<div class="empty-list">Support actions are enemy actions primarily designed to increase the aptitude of themselves or their allies</div>';
                return;
            }
            
            container.innerHTML = supportActions.map(action => `
                <div class="list-item">
                    <div class="list-item-header">
                        <strong>Action ${supportActions.indexOf(action) + 1}</strong>
                        <button type="button" class="btn btn-small btn-danger" onclick="removeSupportAction(${action.id})">Remove</button>
                    </div>
                    <div class="list-item-grid">
                        <div class="field-inline">
                            <label>Type</label>
                            <select onchange="updateSupportAction(${action.id}, 'type', this.value)">
                                <option value="">Select...</option>
                                <option value="heal self" ${action.type === 'heal self' ? 'selected' : ''}>Heal Self</option>
                                <option value="heal other" ${action.type === 'heal other' ? 'selected' : ''}>Heal Other</option>
                                <option value="buff self" ${action.type === 'buff self' ? 'selected' : ''}>Buff Self</option>
                                <option value="buff other" ${action.type === 'buff other' ? 'selected' : ''}>Buff Other</option>
                                <option value="summon" ${action.type === 'summon' ? 'selected' : ''}>Summon</option>
                                <option value="resurrect" ${action.type === 'resurrect' ? 'selected' : ''}>Resurrect</option>
                            </select>
                        </div>
                    </div>
                    <div class="field-inline">
                        <label>Details</label>
                        <textarea onchange="updateSupportAction(${action.id}, 'details', this.value)">${action.details}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function updateSupportAction(id, field, value) {
            const action = supportActions.find(a => a.id === id);
            if (action) action[field] = value;
        }

        // Reactions
        function addReaction() {
            const reaction = {
                id: Date.now(),
                type: '',
                details: ''
            };
            reactions.push(reaction);
            renderReactions();
        }

        function removeReaction(id) {
            reactions = reactions.filter(r => r.id !== id);
            renderReactions();
        }

        function renderReactions() {
            const container = document.getElementById('reactionsList');
            
            if (reactions.length === 0) {
                container.innerHTML = '<div class="empty-list">Reactions are enemy actions triggered when reacting to being damaged</div>';
                return;
            }
            
            container.innerHTML = reactions.map(reaction => `
                <div class="list-item">
                    <div class="list-item-header">
                        <strong>Reaction ${reactions.indexOf(reaction) + 1}</strong>
                        <button type="button" class="btn btn-small btn-danger" onclick="removeReaction(${reaction.id})">Remove</button>
                    </div>
                    <div class="list-item-grid">
                        <div class="field-inline">
                            <label>Type</label>
                            <select onchange="updateReaction(${reaction.id}, 'type', this.value)">
                                <option value="">Select...</option>
                                <option value="standard" ${reaction.type === 'standard' ? 'selected' : ''}>Standard</option>
                                <option value="special" ${reaction.type === 'special' ? 'selected' : ''}>Special</option>
                            </select>
                        </div>
                    </div>
                    <div class="field-inline">
                        <label>Details</label>
                        <textarea onchange="updateReaction(${reaction.id}, 'details', this.value)">${reaction.details}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function updateReaction(id, field, value) {
            const reaction = reactions.find(r => r.id === id);
            if (reaction) reaction[field] = value;
        }

        // Locomotion
        function addLocomotion() {
            const loco = {
                id: Date.now(),
                type: ''
            };
            locomotion.push(loco);
            renderLocomotion();
        }

        function removeLocomotion(id) {
            locomotion = locomotion.filter(l => l.id !== id);
            renderLocomotion();
        }

        function renderLocomotion() {
            const container = document.getElementById('locomotionList');
            
            if (locomotion.length === 0) {
                container.innerHTML = '<div class="empty-list">Locomotion is how the enemy navigates their environment</div>';
                return;
            }
            
            container.innerHTML = locomotion.map(loco => `
                <div class="list-item">
                    <div class="list-item-header">
                        <strong>Locomotion ${locomotion.indexOf(loco) + 1}</strong>
                        <button type="button" class="btn btn-small btn-danger" onclick="removeLocomotion(${loco.id})">Remove</button>
                    </div>
                    <div class="list-item-grid">
                        <div class="field-inline">
                            <label>Type</label>
                            <select onchange="updateLocomotion(${loco.id}, 'type', this.value)">
                                <option value="">Select...</option>
                                <option value="grounded" ${loco.type === 'grounded' ? 'selected' : ''}>Grounded</option>
                                <option value="hovering" ${loco.type === 'hovering' ? 'selected' : ''}>Hovering</option>
                                <option value="flying" ${loco.type === 'flying' ? 'selected' : ''}>Flying</option>
                                <option value="swimming" ${loco.type === 'swimming' ? 'selected' : ''}>Swimming</option>
                            </select>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateLocomotion(id, field, value) {
            const loco = locomotion.find(l => l.id === id);
            if (loco) loco[field] = value;
        }

        // Special Traits
        function addSpecialTrait() {
            const trait = {
                id: Date.now(),
                text: ''
            };
            specialTraits.push(trait);
            renderSpecialTraits();
        }

        function removeSpecialTrait(id) {
            specialTraits = specialTraits.filter(t => t.id !== id);
            renderSpecialTraits();
        }

        function renderSpecialTraits() {
            const container = document.getElementById('specialTraitsList');
            
            if (specialTraits.length === 0) {
                container.innerHTML = '<div class="empty-list">Special Traits are unique passive traits that affect their gameplay systems</div>';
                return;
            }
            
            container.innerHTML = specialTraits.map(trait => `
                <div class="trait-item">
                    <input type="text" value="${trait.text}" onchange="updateSpecialTrait(${trait.id}, this.value)" placeholder="Enter trait..." style="flex: 1; border: 1px solid #ddd; padding: 5px; border-radius: 3px;">
                    <button type="button" class="btn btn-small btn-danger" onclick="removeSpecialTrait(${trait.id})">Remove</button>
                </div>
            `).join('');
        }

        function updateSpecialTrait(id, value) {
            const trait = specialTraits.find(t => t.id === id);
            if (trait) trait.text = value;
        }

        function getVariantKey(displayValue) {
            if (!displayValue) return '';
            
            // Check if we have the key stored
            const input = document.getElementById('variantEnemy');
            if (input.dataset.variantKey) return input.dataset.variantKey;
            
            // Otherwise search for matching enemy
            for (let key in enemies) {
                const enemy = enemies[key];
                if (`${enemy.name} (${enemy.game})` === displayValue) {
                    return key;
                }
            }
            return '';
        }
        
        function showForm(isEdit = false, key = null) {
            if (!currentUser) {
                alert('Please sign in to add or edit enemies.');
                return;
            }

            const formSection = document.getElementById('formSection');
            const formTitle = document.getElementById('formTitle');
            const form = document.getElementById('enemyForm');
            
            formSection.classList.remove('hidden');
            formTitle.textContent = isEdit ? 'Edit Enemy' : 'Add New Enemy';
            
            // Clear complex lists
            offensiveActions = [];
            defensiveActions = [];
            supportActions = [];
            reactions = [];
            locomotion = [];
            specialTraits = [];
            
            if (isEdit && key) {
                editingKey = key;
                const enemy = enemies[key];
                
                // Basic fields
                document.getElementById('enemyName').value = enemy.name;
                document.getElementById('gameName').value = enemy.game;
                document.getElementById('enemyType').value = enemy.type || '';
                document.getElementById('enemySize').value = enemy.size || '';
                document.getElementById('enemyFaction').value = enemy.faction || '';
                document.getElementById('enemyWeapon').value = enemy.weapon || '';
                document.getElementById('referenceLink').value = enemy.referenceLink || '';
                document.getElementById('videoLink').value = enemy.videoLink || '';
                document.getElementById('imageLink').value = enemy.imageLink || '';
                document.getElementById('notes').value = enemy.notes || '';
                
                const variantInput = document.getElementById('variantEnemy');
                if (enemy.variant && enemies[enemy.variant]) {
                    const variantEnemy = enemies[enemy.variant];
                    variantInput.value = `${variantEnemy.name} (${variantEnemy.game})`;
                    variantInput.dataset.variantKey = enemy.variant;
                } else {
                    variantInput.value = '';
                    variantInput.dataset.variantKey = '';
                }
                
                // Complex fields
                if (enemy.offensiveActions) {
                    offensiveActions = enemy.offensiveActions.map(a => ({...a, id: Date.now() + Math.random()}));
                }
                if (enemy.defensiveActions) {
                    defensiveActions = enemy.defensiveActions.map(a => ({...a, id: Date.now() + Math.random()}));
                }
                if (enemy.supportActions) {
                    supportActions = enemy.supportActions.map(a => ({...a, id: Date.now() + Math.random()}));
                }
                if (enemy.reactions) {
                    reactions = enemy.reactions.map(r => ({...r, id: Date.now() + Math.random()}));
                }
                if (enemy.locomotion) {
                    locomotion = enemy.locomotion.map(l => ({...l, id: Date.now() + Math.random()}));
                }
                if (enemy.specialTraits) {
                    specialTraits = enemy.specialTraits.map(t => ({id: Date.now() + Math.random(), text: t}));
                }
            } else {
                editingKey = null;
                form.reset();
            }
            
            renderOffensiveActions();
            renderDefensiveActions();
            renderSupportActions();
            renderReactions();
            renderLocomotion();
            renderSpecialTraits();
            updateVariantDropdown();
            updateFormDatalists();
            
            formSection.scrollIntoView({ behavior: 'smooth' });
        }

        function hideForm() {
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('enemyForm').reset();
            editingKey = null;
            offensiveActions = [];
            defensiveActions = [];
            supportActions = [];
            reactions = [];
            locomotion = [];
            specialTraits = [];
        }

        function renderEnemies(searchTerm = '') {
            const listContainer = document.getElementById('enemyList');
            
            let enemyArray = Object.keys(enemies).map(key => ({
                key: key,
                ...enemies[key]
            }));
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                enemyArray = enemyArray.filter(enemy => {
                    // Search basic fields
                    if (enemy.name?.toLowerCase().includes(term)) return true;
                    if (enemy.game?.toLowerCase().includes(term)) return true;
                    if (enemy.type?.toLowerCase().includes(term)) return true;
                    if (enemy.size?.toLowerCase().includes(term)) return true;
                    if (enemy.faction?.toLowerCase().includes(term)) return true;
                    if (enemy.weapon?.toLowerCase().includes(term)) return true;
                    if (enemy.notes?.toLowerCase().includes(term)) return true;
                    if (enemy.referenceLink?.toLowerCase().includes(term)) return true;
                    if (enemy.videoLink?.toLowerCase().includes(term)) return true;
                    if (enemy.imageLink?.toLowerCase().includes(term)) return true;
                    
                    // Search offensive actions - ALL FIELDS
                    if (enemy.offensiveActions?.some(a => 
                        a.name?.toLowerCase().includes(term) ||
                        a.type?.toLowerCase().includes(term) ||
                        a.range?.toLowerCase().includes(term) ||
                        a.comboCount?.toString().toLowerCase().includes(term) ||
                        a.windupTime?.toLowerCase().includes(term) ||
                        a.damageType?.toLowerCase().includes(term) ||
                        a.condition?.toLowerCase().includes(term) ||
                        a.details?.toLowerCase().includes(term)
                    )) return true;
                    
                    // Search defensive actions - ALL FIELDS
                    if (enemy.defensiveActions?.some(a =>
                        a.type?.toLowerCase().includes(term) ||
                        a.defensiveReaction?.toLowerCase().includes(term) ||
                        a.details?.toLowerCase().includes(term)
                    )) return true;
                    
                    // Search support actions - ALL FIELDS
                    if (enemy.supportActions?.some(a =>
                        a.type?.toLowerCase().includes(term) ||
                        a.details?.toLowerCase().includes(term)
                    )) return true;
                    
                    // Search reactions - ALL FIELDS
                    if (enemy.reactions?.some(r =>
                        r.type?.toLowerCase().includes(term) ||
                        r.details?.toLowerCase().includes(term)
                    )) return true;
                    
                    // Search locomotion
                    if (enemy.locomotion?.some(l =>
                        l.type?.toLowerCase().includes(term)
                    )) return true;
                    
                    // Search special traits
                    if (enemy.specialTraits?.some(t =>
                        t.toLowerCase().includes(term)
                    )) return true;
                    
                    return false;
                });
            }
            
            if (enemyArray.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>${searchTerm ? 'No enemies found' : 'No enemies yet'}</h3>
                        <p>${searchTerm ? 'Try a different search term' : currentUser ? 'Click "Add New Enemy" to get started' : 'Sign in to add enemies'}</p>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = enemyArray.map((enemy) => {
                let badges = '';
                if (enemy.type) badges += `<span class="badge type">${enemy.type}</span>`;
                if (enemy.size) badges += `<span class="badge size">${enemy.size}</span>`;
                if (enemy.faction) badges += `<span class="badge">${enemy.faction}</span>`;
                if (enemy.weapon) badges += `<span class="badge weapon">${enemy.weapon}</span>`;
                
                let links = '';
                if (enemy.referenceLink) links += `<a href="${enemy.referenceLink}" target="_blank">📚 Wiki</a>`;
                if (enemy.videoLink) links += `<a href="${enemy.videoLink}" target="_blank">🎥 Video</a>`;
                if (enemy.imageLink) links += `<a href="${enemy.imageLink}" target="_blank">🖼️ Image</a>`;
                
                let complexSections = '';
                
                // Offensive Actions
                if (enemy.offensiveActions && enemy.offensiveActions.length > 0) {
                    complexSections += `
                        <div class="enemy-section">
                            <h4>⚔️ Offensive Actions (${enemy.offensiveActions.length})</h4>
                            ${enemy.offensiveActions.map(a => `
                                <div class="action-display">
                                    <strong>${a.name || a.type || 'Action'}:</strong> 
                                    ${a.range ? `Range: ${a.range}` : ''} 
                                    ${a.comboCount ? `| Combo: ${a.comboCount}` : ''} 
                                    ${a.windupTime ? `| Windup: ${a.windupTime}` : ''}
                                    ${a.damageType ? `| Damage: ${a.damageType}` : ''}
                                    ${a.condition ? `| Condition: ${a.condition}` : ''}
                                    ${a.details ? `<br>${a.details}` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Defensive Actions
                if (enemy.defensiveActions && enemy.defensiveActions.length > 0) {
                    complexSections += `
                        <div class="enemy-section">
                            <h4>🛡️ Defensive Actions (${enemy.defensiveActions.length})</h4>
                            ${enemy.defensiveActions.map(a => `
                                <div class="action-display">
                                    <strong>${a.type || 'Defense'}:</strong> 
                                    ${a.defensiveReaction ? `Reaction: ${a.defensiveReaction}` : ''}
                                    ${a.details ? `<br>${a.details}` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Support Actions
                if (enemy.supportActions && enemy.supportActions.length > 0) {
                    complexSections += `
                        <div class="enemy-section">
                            <h4>✨ Support Actions (${enemy.supportActions.length})</h4>
                            ${enemy.supportActions.map(a => `
                                <div class="action-display">
                                    <strong>${a.type || 'Support'}:</strong> 
                                    ${a.details || ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Reactions
                if (enemy.reactions && enemy.reactions.length > 0) {
                    complexSections += `
                        <div class="enemy-section">
                            <h4>⚡ Reactions (${enemy.reactions.length})</h4>
                            ${enemy.reactions.map(r => `
                                <div class="action-display">
                                    <strong>${r.type || 'Reaction'}:</strong> 
                                    ${r.details || ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Locomotion
                if (enemy.locomotion && enemy.locomotion.length > 0) {
                    complexSections += `
                        <div class="enemy-section">
                            <h4>🦶 Locomotion</h4>
                            ${enemy.locomotion.map(l => `<span class="badge">${l.type}</span>`).join(' ')}
                        </div>
                    `;
                }
                
                // Special Traits
                if (enemy.specialTraits && enemy.specialTraits.length > 0) {
                    complexSections += `
                        <div class="enemy-section">
                            <h4>⭐ Special Traits</h4>
                            ${enemy.specialTraits.map(t => `<div class="action-display">${t}</div>`).join('')}
                        </div>
                    `;
                }
                
                // Variants - show entire network
                const allVariants = findAllVariants(enemy.key);
                if (allVariants.length > 0) {
                    const variantLinks = allVariants
                        .filter(key => enemies[key]) // Make sure enemy still exists
                        .map(key => {
                            const variantEnemy = enemies[key];
                            return `
                                <a href="#" class="variant-link" onclick="event.preventDefault(); scrollToEnemy('${key}')" style="margin-right: 8px; margin-bottom: 8px; display: inline-block;">
                                    → ${variantEnemy.name} (${variantEnemy.game})
                                </a>
                            `;
                        })
                        .join('');
                    
                    complexSections += `
                        <div class="enemy-section">
                            <h4>🔗 Variants (${allVariants.length})</h4>
                            <div style="display: flex; flex-wrap: wrap;">
                                ${variantLinks}
                            </div>
                        </div>
                    `;
                }
                
                const actions = currentUser ? `
                    <div class="enemy-actions">
                        <button class="btn btn-secondary" onclick="editEnemy('${enemy.key}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteEnemy('${enemy.key}')">Delete</button>
                    </div>
                ` : '';
                
                return `
                    <div class="enemy-card" id="enemy-${enemy.key}">
                        <div class="enemy-compact-info">
                            <div class="enemy-header">
                                <div class="enemy-title">
                                    <h3>${enemy.name}</h3>
                                    <div class="enemy-game">${enemy.game}</div>
                                </div>
                            </div>
                            ${badges ? `<div class="enemy-badges">${badges}</div>` : ''}
                            ${links ? `<div class="enemy-links">${links}</div>` : ''}
                            
                            ${complexSections || enemy.notes ? `
                                <button class="expand-button" onclick="toggleEnemyDetails('${enemy.key}')">
                                    <span class="expand-icon" id="icon-${enemy.key}">▼</span>
                                    <span id="text-${enemy.key}">Show Details</span>
                                </button>
                            ` : ''}
                        </div>
                        
                        ${complexSections || enemy.notes ? `
                            <div class="enemy-detailed-info" id="details-${enemy.key}">
                                ${enemy.notes ? `<div class="enemy-notes" style="margin-top: 15px;">${enemy.notes}</div>` : ''}
                                ${complexSections}
                            </div>
                        ` : ''}
                        
                        ${actions}
                    </div>
                `;
            }).join('');
        }

        function scrollToEnemy(key) {
            const element = document.getElementById(`enemy-${key}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.background = '#fff3cd';
                setTimeout(() => {
                    element.style.background = '';
                }, 2000);
            }
        }

        document.getElementById('enemyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please sign in to save enemies.');
                return;
            }
            
            // Clean up actions (remove temp IDs)
            const cleanOffensive = offensiveActions.map(a => {
                const {id, ...rest} = a;
                return rest;
            });
            const cleanDefensive = defensiveActions.map(a => {
                const {id, ...rest} = a;
                return rest;
            });
            const cleanSupport = supportActions.map(a => {
                const {id, ...rest} = a;
                return rest;
            });
            const cleanReactions = reactions.map(r => {
                const {id, ...rest} = r;
                return rest;
            });
            const cleanLocomotion = locomotion.map(l => {
                const {id, ...rest} = l;
                return rest;
            });
            const cleanTraits = specialTraits.map(t => t.text).filter(t => t.trim() !== '');
            
            const enemy = {
                name: document.getElementById('enemyName').value,
                game: document.getElementById('gameName').value,
                type: document.getElementById('enemyType').value,
                size: document.getElementById('enemySize').value,
                faction: document.getElementById('enemyFaction').value,
                weapon: document.getElementById('enemyWeapon').value,
                referenceLink: document.getElementById('referenceLink').value,
                videoLink: document.getElementById('videoLink').value,
                imageLink: document.getElementById('imageLink').value,
                notes: document.getElementById('notes').value,
                variant: getVariantKey(document.getElementById('variantEnemy').value),
                offensiveActions: cleanOffensive,
                defensiveActions: cleanDefensive,
                supportActions: cleanSupport,
                reactions: cleanReactions,
                locomotion: cleanLocomotion,
                specialTraits: cleanTraits,
                createdBy: currentUser.uid,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            const enemiesRef = database.ref('enemies');
            
            if (editingKey) {
                enemiesRef.child(editingKey).update(enemy);
            } else {
                enemiesRef.push(enemy);
            }
            
            hideForm();
        });

        function editEnemy(key) {
            showForm(true, key);
        }

        function deleteEnemy(key) {
            if (!currentUser) {
                alert('Please sign in to delete enemies.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this enemy?')) {
                database.ref('enemies/' + key).remove();
            }
        }

        document.getElementById('addNewBtn').addEventListener('click', () => showForm());
        document.getElementById('cancelBtn').addEventListener('click', hideForm);
        document.getElementById('searchBox').addEventListener('input', (e) => {
            renderEnemies(e.target.value);
        });
    </script>
</body>
</html>
